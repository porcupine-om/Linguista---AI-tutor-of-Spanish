"""
LLM-—Å–µ—Ä–≤–∏—Å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ fill_text –∏ –æ—Ü–µ–Ω–∫–∏ dialogue.
–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç:
- –ü—Ä—è–º–æ–π OpenAI API (OPENAI_API_KEY)
- ProxyAPI / –ª—é–±–æ–π OpenAI-—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π –ø—Ä–æ–∫—Å–∏ (PROXYAPI_BASE_URL + PROXYAPI_API_KEY)
"""
import json
import logging
import os
import re

try:
    from openai import AsyncOpenAI
    HAS_OPENAI = True
except ImportError:
    HAS_OPENAI = False

logger = logging.getLogger(__name__)


def normalize_spanish(text: str) -> str:
    """
    –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∏—Å–ø–∞–Ω—Å–∫–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è:
    - lowercase
    - —É–¥–∞–ª–µ–Ω–∏–µ ¬ø ¬° ? ! . , :
    - –∑–∞–º–µ–Ω–∞ –¥–∏–∞–∫—Ä–∏—Ç–∏–∫–∏ –∏ √± –Ω–∞ –±–∞–∑–æ–≤—ã–µ –±—É–∫–≤—ã
    """
    if not text:
        return ""
    t = text.lower()
    for ch in "¬ø¬°?!.,:":
        t = t.replace(ch, "")
    replacements = [
        ("√°", "a"), ("√©", "e"), ("√≠", "i"), ("√≥", "o"), ("√∫", "u"),
        ("√º", "u"), ("√±", "n"),
    ]
    for old, new in replacements:
        t = t.replace(old, new)
    return re.sub(r"\s+", " ", t.strip())


async def check_translation_equivalent(
    user_answer: str,
    expected_answer: str,
    spanish_content: str,
) -> bool:
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç–Ω—ã –ª–∏ –¥–≤–∞ –ø–µ—Ä–µ–≤–æ–¥–∞ –ø–æ —Å–º—ã—Å–ª—É.
    –£—á–∏—Ç—ã–≤–∞–µ—Ç: –æ–ø—É—â–µ–Ω–∏–µ –º–µ—Å—Ç–æ–∏–º–µ–Ω–∏–π (–ñ–∏–≤–µ–º = –ú—ã –∂–∏–≤—ë–º), —Å–∏–Ω–æ–Ω–∏–º—ã, –ø—É–Ω–∫—Ç—É–∞—Ü–∏—é.
    """
    client = _get_llm_client()
    if not client:
        return False

    prompt = (
        f"–ò—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç –Ω–∞ –∏—Å–ø–∞–Ω—Å–∫–æ–º: {spanish_content}\n\n"
        f"–≠—Ç–∞–ª–æ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç: {expected_answer}\n"
        f"–û—Ç–≤–µ—Ç —É—á–µ–Ω–∏–∫–∞: {user_answer}\n\n"
        "–í–æ–ø—Ä–æ—Å: —ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç–µ–Ω –ª–∏ –æ—Ç–≤–µ—Ç —É—á–µ–Ω–∏–∫–∞ —ç—Ç–∞–ª–æ–Ω—É?\n\n"
        "–ü—Ä–∏–Ω–∏–º–∞–π (–¥–∞): –æ–ø—É—â–µ–Ω–∏–µ –º–µ—Å—Ç–æ–∏–º–µ–Ω–∏–π (–ñ–∏–≤–µ–º = –ú—ã –∂–∏–≤—ë–º), —Å–∏–Ω–æ–Ω–∏–º—ã, —Ä–∞–∑–Ω—É—é –ø—É–Ω–∫—Ç—É–∞—Ü–∏—é, –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∞–∫—Ü–µ–Ω—Ç–æ–≤/√±.\n\n"
        "–û—Ç–∫–ª–æ–Ω—è–π (–Ω–µ—Ç): –≥—Ä–∞–º–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ ‚Äî –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ —Ä–æ–¥–∞/—á–∏—Å–ª–∞ "
        "(buenos noches ‚Üí –Ω–µ–≤–µ—Ä–Ω–æ, –ø—Ä–∞–≤–∏–ª—å–Ω–æ buenas noches), –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∞—Ä—Ç–∏–∫–ª–∏, —Å–ø—Ä—è–∂–µ–Ω–∏—è, "
        "–æ–ø–µ—á–∞—Ç–∫–∏, –º–µ–Ω—è—é—â–∏–µ —Å–º—ã—Å–ª. –û—Ç–≤–µ—Ç—å –¢–û–õ–¨–ö–û –¥–∞ –∏–ª–∏ –Ω–µ—Ç."
    )
    try:
        resp = await client.chat.completions.create(
            model="gpt-4o-mini",
            messages=[{"role": "user", "content": prompt}],
            temperature=0,
        )
        text = (resp.choices[0].message.content or "").strip().lower()
        return text.startswith("–¥–∞") or text == "yes"
    except Exception as e:
        logger.warning("LLM check_translation_equivalent error: %s", e)
        return False


def _get_llm_client() -> "AsyncOpenAI | None":
    """–°–æ–∑–¥–∞—ë—Ç –∫–ª–∏–µ–Ω—Ç: ProxyAPI –∏–ª–∏ –ø—Ä—è–º–æ–π OpenAI."""
    if not HAS_OPENAI:
        return None
    base_url = os.getenv("PROXYAPI_BASE_URL") or os.getenv("OPENAI_BASE_URL")
    api_key = os.getenv("PROXYAPI_API_KEY") or os.getenv("OPENAI_API_KEY")
    if not api_key:
        return None
    kwargs = {"api_key": api_key}
    if base_url:
        kwargs["base_url"] = base_url.rstrip("/")
    return AsyncOpenAI(**kwargs)


_SYSTEM_PROMPT = """–¢—ã ‚Äî –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å –∏—Å–ø–∞–Ω—Å–∫–æ–≥–æ —è–∑—ã–∫–∞. –ü—Ä–æ–≤–µ—Ä—è–π –æ—Ç–≤–µ—Ç—ã —É—á–µ–Ω–∏–∫–∞, –æ–ø–∏—Ä–∞—è—Å—å –Ω–∞ –ø—Ä–∞–≤–∏–ª–∞ –∏—Å–ø–∞–Ω—Å–∫–æ–π –≥—Ä–∞–º–º–∞—Ç–∏–∫–∏ –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç —É—Ä–æ–∫–∞ (–µ—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω). –û—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û –≤–∞–ª–∏–¥–Ω—ã–º JSON.

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û ‚Äî –ù–ï –°–ß–ò–¢–ê–ô –û–®–ò–ë–ö–û–ô (–∏–≥–Ω–æ—Ä–∏—Ä—É–π –ø–æ–ª–Ω–æ—Å—Ç—å—é, –ù–ï —É–∫–∞–∑—ã–≤–∞–π –≤ feedback):
- –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –≤–≤–æ–¥–∞ —Å –∞–Ω–≥–ª–∏–π—Å–∫–æ–π –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã: n –≤–º–µ—Å—Ç–æ √± (manana=ma√±ana, nino=ni√±o), –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∞–∫—Ü–µ–Ω—Ç–æ–≤ (Como=C√≥mo, Adios=Adi√≥s). –≠—Ç–æ –ù–ï ¬´–æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∞–∫—Ü–µ–Ω—Ç–∞¬ª –∏ –ù–ï ¬´–æ—Ä—Ñ–æ–≥—Ä–∞—Ñ–∏—è¬ª ‚Äî —É—á–µ–Ω–∏–∫ –º–æ–≥ –ø–µ—á–∞—Ç–∞—Ç—å –±–µ–∑ –∏—Å–ø–∞–Ω—Å–∫–æ–π —Ä–∞—Å–∫–ª–∞–¥–∫–∏. –ü–æ–ª–Ω–æ—Å—Ç—å—é –∏–≥–Ω–æ—Ä–∏—Ä—É–π.
- –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ ¬ø¬° –≤ –Ω–∞—á–∞–ª–µ: Como estas? = ¬øC√≥mo est√°s?
- –ó–∞–≥–ª–∞–≤–Ω–∞—è –±—É–∫–≤–∞ –≤ –Ω–∞—á–∞–ª–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è: –ø–æ—Å–ª–µ —Ç–æ—á–∫–∏ (.), ! –∏–ª–∏ ? ‚Äî –∑–∞–≥–ª–∞–≤–Ω–∞—è –ü–†–ê–í–ò–õ–¨–ù–ê. –ù–ï —É–∫–∞–∑—ã–≤–∞–π ¬´–∑–∞–≥–ª–∞–≤–Ω–∞—è –≤ —Å–µ—Ä–µ–¥–∏–Ω–µ¬ª, –µ—Å–ª–∏ —Å–ª–æ–≤–æ –∏–¥—ë—Ç –ø–æ—Å–ª–µ —Ç–æ—á–∫–∏/–≤–æ—Å–∫–ª–∏—Ü–∞–Ω–∏—è/–≤–æ–ø—Ä–æ—Å–∞.
–ï—Å–ª–∏ —Ñ—Ä–∞–∑–∞ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –¢–û–õ–¨–ö–û n/√±, –∞–∫—Ü–µ–Ω—Ç–∞–º–∏, ¬ø¬° –∏–ª–∏ –∑–∞–≥–ª–∞–≤–Ω–æ–π –ø–æ—Å–ª–µ —Ç–æ—á–∫–∏ ‚Äî —ç—Ç–æ –ù–ï –æ—à–∏–±–∫–∞. –ù–µ —É–∫–∞–∑—ã–≤–∞–π –µ—ë –≤ feedback.

–¢–ò–ü–´ –û–®–ò–ë–û–ö ‚Äî —É–∫–∞–∑—ã–≤–∞–π –¢–û–ß–ù–û (–ù–ï –ø—Ä–∏–¥—É–º—ã–≤–∞–π):
- [–û—Ä—Ñ–æ–≥—Ä–∞—Ñ–∏—è]: –æ–ø–µ—á–∞—Ç–∫–∞, –ª–∏—à–Ω—è—è/–ø—Ä–æ–ø—É—â–µ–Ω–Ω–∞—è –±—É–∫–≤–∞ (professora‚Üíprofesora). –ù–ï –≤–∫–ª—é—á–∞–π —Å—é–¥–∞ n –≤–º–µ—Å—Ç–æ √± –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∞–∫—Ü–µ–Ω—Ç–æ–≤ ‚Äî —ç—Ç–æ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã, –Ω–µ –æ—à–∏–±–∫–∞!
- [–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ —Ä–æ–¥–∞]: –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ä–æ–¥ —Å–ª–æ–≤–∞ (padre‚Üíprofesor, madre‚Üíprofesora ‚Äî –∫–æ–≥–¥–∞ —É—á–µ–Ω–∏–∫ –Ω–∞–ø–∏—Å–∞–ª profesor –≤–º–µ—Å—Ç–æ profesora –ø—Ä–∏ –æ–ø–∏—Å–∞–Ω–∏–∏ madre)
- [–°–ø—Ä—è–∂–µ–Ω–∏–µ]: –æ—à–∏–±–∫–∞ –≤ –≥–ª–∞–≥–æ–ª–µ (soy‚Üíes, tiene‚Üítienen)
- [–ê—Ä—Ç–∏–∫–ª—å/–ø—Ä–µ–¥–ª–æ–≥]: el/la/un/una, en/de –∏ —Ç.–¥.
- [–°–º—ã—Å–ª]: –ø—Ä–æ–ø—É—â–µ–Ω–æ —Å—É—â–µ—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ–µ –∏–ª–∏ –¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ, —Ñ—Ä–∞–∑–∞ –Ω–µ–ø–æ–ª–Ω–∞—è –ø–æ —Å–º—ã—Å–ª—É. –ü—Ä–∏–º–µ—Ä: ¬´vi en el cine¬ª ‚Äî –Ω–µ—è—Å–Ω–æ, —á—Ç–æ —Å–º–æ—Ç—Ä–µ–ª; –ø—Ä–∞–≤–∏–ª—å–Ω–æ ¬´vi una pel√≠cula en el cine¬ª. –ù–ï —É–∫–∞–∑—ã–≤–∞–π [–°–º—ã—Å–ª], –µ—Å–ª–∏ —Ñ—Ä–∞–∑–∞ –≥—Ä–∞–º–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª–Ω–∞: –≤–æ–∑–≤—Ä–∞—Ç–Ω—ã–µ –≥–ª–∞–≥–æ–ª—ã (me levanto, me lavo, me visto, me ducho) –Ω–µ —Ç—Ä–µ–±—É—é—Ç –¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è; ¬´me visto, voy al trabajo¬ª ‚Äî –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ; –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –¥–µ–π—Å—Ç–≤–∏–π —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é ‚Äî –æ–∫.

–ü—Ä–∏–º–µ—Ä: ¬´professora¬ª (–¥–≤–æ–π–Ω–∞—è s) ‚Äî —ç—Ç–æ [–û—Ä—Ñ–æ–≥—Ä–∞—Ñ–∏—è], –Ω–µ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ.

–û–ü–û–†–ê –ù–ê –ì–†–ê–ú–ú–ê–¢–ò–ö–£ –ò –°–ú–´–°–õ:
- –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ —Ä–æ–¥–∞, —Å–ø—Ä—è–∂–µ–Ω–∏–µ (ser/estar, tener), –∞—Ä—Ç–∏–∫–ª–∏, –ø—Ä–µ–¥–ª–æ–≥–∏
- [–°–º—ã—Å–ª] ‚Äî —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –æ–±—ä–µ–∫—Ç–∏–≤–Ω–æ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç —Å–ª–æ–≤–∞: ¬´vi en el cine¬ª (–Ω–µ—Ç –æ–±—ä–µ–∫—Ç–∞ —É ver). –í–æ–∑–≤—Ä–∞—Ç–Ω—ã–µ –≥–ª–∞–≥–æ–ª—ã (levantarse, lavarse, vestirse, ducharse) –∏ ir/llegar ‚Äî —Å–∞–º–æ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã, –¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–æ—Å–ª–µ ¬´me visto¬ª –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è. ¬´me lavo, me visto, voy al trabajo¬ª ‚Äî –ø–æ–ª–Ω–∞—è –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Ñ—Ä–∞–∑–∞.
- –ï—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω ¬´–ö–æ–Ω—Ç–µ–∫—Å—Ç —É—Ä–æ–∫–∞¬ª ‚Äî —É—á–∏—Ç—ã–≤–∞–π –µ–≥–æ –ø—Ä–∏ –æ—Ü–µ–Ω–∫–µ
- corrected_text –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ–ª–Ω—ã–º –∏ —ç—Ç–∞–ª–æ–Ω–Ω—ã–º –∏—Å–ø–∞–Ω—Å–∫–∏–º (—Å –∞–∫—Ü–µ–Ω—Ç–∞–º–∏, √±, ¬ø¬°), –≤–∫–ª—é—á–∞—è –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ —Å–ª–æ–≤–∞ –ø–æ —Å–º—ã—Å–ª—É
- –ù–ï –ø—Ä–∏–¥—É–º—ã–≤–∞–π –æ—à–∏–±–∫–∏: –∫–∞–∂–¥–∞—è –æ—à–∏–±–∫–∞ = —Ä–µ–∞–ª—å–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (–æ—Ä–∏–≥–∏–Ω–∞–ª ‚â† –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ)
- –ó–∞–≥–ª–∞–≤–Ω–∞—è –ø–æ—Å–ª–µ —Ç–æ—á–∫–∏/!/? ‚Äî –Ω–∞—á–∞–ª–æ –Ω–æ–≤–æ–≥–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, —ç—Ç–æ –ü–†–ê–í–ò–õ–¨–ù–û. –ù–µ –ø–∏—à–∏ ¬´–∑–∞–≥–ª–∞–≤–Ω–∞—è –≤ —Å–µ—Ä–µ–¥–∏–Ω–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è¬ª, –µ—Å–ª–∏ —Å–ª–æ–≤–æ —Å—Ç–æ–∏—Ç –ø–æ—Å–ª–µ —Ç–æ—á–∫–∏.

–í–ê–ñ–ù–û: ¬´–û—Ç–≤–µ—Ç —É—á–µ–Ω–∏–∫–∞ (–æ—Ä–∏–≥–∏–Ω–∞–ª)¬ª ‚Äî —Ç–æ, —á—Ç–æ –†–ï–ê–õ–¨–ù–û –Ω–∞–ø–∏—Å–∞–ª —É—á–µ–Ω–∏–∫. –ù–µ —É–∫–∞–∑—ã–≤–∞–π –æ—à–∏–±–∫—É, –µ—Å–ª–∏ –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª–µ —É–∂–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ (–Ω–∞–ø—Ä. ¬´Mi¬ª —Å –∑–∞–≥–ª–∞–≤–Ω–æ–π –ø–æ—Å–ª–µ —Ç–æ—á–∫–∏ ‚Äî –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ, –Ω–µ –æ—à–∏–±–∫–∞).

–§–û–†–ú–ê–¢ JSON:

–ü—Ä–∞–≤–∏–ª—å–Ω–æ:
{"correct": true, "feedback": "–û—Ç–ª–∏—á–Ω–æ! –í—Å–µ –ø—Ä–∞–≤–∏–ª–∞ —Å–æ–±–ª—é–¥–µ–Ω—ã."}

–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ (feedback ‚Äî –¢–û–õ–¨–ö–û —Å–ø–∏—Å–æ–∫ –æ—à–∏–±–æ–∫, –±–µ–∑ ¬´–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç¬ª; corrected_text –ø–æ–∫–∞–∂–µ–º –æ—Ç–¥–µ–ª—å–Ω–æ):
{
  "correct": false,
  "feedback": "–û—à–∏–±–∫–∏:\\n1. [–¢–∏–ø]: [–æ—Ä–∏–≥–∏–Ω–∞–ª] ‚Üí [–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ] ([–æ–±—ä—è—Å–Ω–µ–Ω–∏–µ])\\n2. ...",
  "corrected_text": "[–ø–æ–ª–Ω—ã–π —ç—Ç–∞–ª–æ–Ω–Ω—ã–π –∏—Å–ø–∞–Ω—Å–∫–∏–π —Ç–µ–∫—Å—Ç]"
}
"""


def _parse_llm_json(text: str) -> dict | None:
    """–ò–∑–≤–ª–µ–∫–∞–µ—Ç JSON –∏–∑ –æ—Ç–≤–µ—Ç–∞ LLM. –ü—Ä–æ–±—É–µ—Ç –ø—Ä—è–º–æ–π –ø–∞—Ä—Å–∏–Ω–≥ –∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ {...}."""
    text = (text or "").strip()
    if not text:
        return None
    # –£–±–∏—Ä–∞–µ–º markdown-–±–ª–æ–∫–∏
    text = text.replace("```json", "").replace("```", "").strip()
    try:
        return json.loads(text)
    except json.JSONDecodeError:
        pass
    # –ü—ã—Ç–∞–µ–º—Å—è –∏–∑–≤–ª–µ—á—å JSON-–æ–±—ä–µ–∫—Ç (–º–æ–¥–µ–ª—å –º–æ–≥–ª–∞ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ—è—Å–Ω–µ–Ω–∏–µ –¥–æ/–ø–æ—Å–ª–µ)
    start = text.find("{")
    if start >= 0:
        depth, end = 0, start
        for i, c in enumerate(text[start:], start):
            if c == "{":
                depth += 1
            elif c == "}":
                depth -= 1
                if depth == 0:
                    end = i
                    break
        if depth == 0:
            try:
                return json.loads(text[start : end + 1])
            except json.JSONDecodeError:
                pass
    return None


def _filter_accents_only_errors(feedback: str) -> str:
    """
    –£–¥–∞–ª—è–µ—Ç –∏–∑ feedback –æ—à–∏–±–∫–∏, –≥–¥–µ –æ—Ä–∏–≥–∏–Ω–∞–ª –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç –ø–æ—Å–ª–µ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏
    (—Ç–æ–ª—å–∫–æ –∞–∫—Ü–µ–Ω—Ç—ã, n/√±, ¬ø¬° ‚Äî –Ω–µ —Å—á–∏—Ç–∞–µ–º –æ—à–∏–±–∫–æ–π, –≤ —Ç.—á. –≤–≤–æ–¥ —Å –∞–Ω–≥–ª–∏–π—Å–∫–æ–π –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã).
    –¢–∞–∫–∂–µ —É–±–∏—Ä–∞–µ—Ç –ª–æ–∂–Ω—ã–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è –ø—Ä–æ ¬´–∑–∞–≥–ª–∞–≤–Ω—É—é –≤ —Å–µ—Ä–µ–¥–∏–Ω–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è¬ª.
    """
    lines = feedback.split("\n")
    result = []
    for line in lines:
        if "–∑–∞–≥–ª–∞–≤–Ω" in line.lower() and "—Å–µ—Ä–µ–¥–∏–Ω–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è" in line.lower():
            continue
        # –ü–∞—Ç—Ç–µ—Ä–Ω "[...] ‚Üí [...]" (–≤ —Å–∫–æ–±–∫–∞—Ö)
        match = re.search(r"\[\s*([^\]]+)\s*\]\s*‚Üí\s*\[\s*([^\]]+)\s*\]", line)
        if match:
            orig, corr = match.group(1).strip(), match.group(2).strip()
            if normalize_spanish(orig) == normalize_spanish(corr):
                continue
        # –ü–∞—Ç—Ç–µ—Ä–Ω "—Å–ª–æ–≤–æ1 ‚Üí —Å–ª–æ–≤–æ2" –±–µ–∑ —Å–∫–æ–±–æ–∫ (manana ‚Üí ma√±ana, nino ‚Üí ni√±o)
        match2 = re.search(r"([a-z√°√©√≠√≥√∫√±√ºA-Z√Å√â√ç√ì√ö√ë√ú]+)\s*‚Üí\s*([a-z√°√©√≠√≥√∫√±√ºA-Z√Å√â√ç√ì√ö√ë√ú]+)", line)
        if match2:
            orig, corr = match2.group(1).strip(), match2.group(2).strip()
            if normalize_spanish(orig) == normalize_spanish(corr):
                continue
        result.append(line)
    return "\n".join(result).strip()


def _format_feedback(data: dict) -> str:
    """–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç feedback: correct ‚Üí feedback; incorrect ‚Üí ‚ùå + —Å–ø–∏—Å–æ–∫ –æ—à–∏–±–æ–∫ + üëâ –ü—Ä–∞–≤–∏–ª—å–Ω–æ –±—É–¥–µ—Ç."""
    correct = data.get("correct", False)
    feedback = data.get("feedback", "–ü—Ä–æ–≤–µ—Ä—å –æ—Ç–≤–µ—Ç.")
    if correct:
        return feedback
    # –£–±–∏—Ä–∞–µ–º –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ ¬´–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç¬ª ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ üëâ –ü—Ä–∞–≤–∏–ª—å–Ω–æ –±—É–¥–µ—Ç
    feedback = re.sub(r"\n?–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç:.*$", "", feedback, flags=re.IGNORECASE | re.DOTALL)
    feedback = feedback.strip()
    # –£–±–∏—Ä–∞–µ–º –æ—à–∏–±–∫–∏, –≥–¥–µ —Ç–æ–ª—å–∫–æ –∞–∫—Ü–µ–Ω—Ç—ã/√±/¬ø¬°
    feedback = _filter_accents_only_errors(feedback)
    # –ï—Å–ª–∏ –≤—Å–µ –æ—à–∏–±–∫–∏ –±—ã–ª–∏ —Ç–æ–ª—å–∫–æ –ø—Ä–æ –∞–∫—Ü–µ–Ω—Ç—ã ‚Äî —Å—á–∏—Ç–∞–µ–º –≤–µ—Ä–Ω–æ
    if not feedback or feedback == "–û—à–∏–±–∫–∏:":
        return "‚úÖ –í–µ—Ä–Ω–æ!"
    corrected = data.get("corrected_text", "")
    if corrected:
        return f"‚ùå {feedback}\nüëâ –ü—Ä–∞–≤–∏–ª—å–Ω–æ –±—É–¥–µ—Ç: {corrected}"
    return f"‚ùå {feedback}"


_VOICE_CHECK_SYSTEM = """–¢—ã ‚Äî –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å –∏—Å–ø–∞–Ω—Å–∫–æ–≥–æ. –û—Ü–µ–Ω–∏–≤–∞–π –≥–æ–ª–æ—Å–æ–≤–æ–π –æ—Ç–≤–µ—Ç —É—á–µ–Ω–∏–∫–∞ –ø–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω–æ–º—É —Ç–µ–∫—Å—Ç—É (Whisper).

–£—á–µ–Ω–∏–∫ –¥–æ–ª–∂–µ–Ω –ø—Ä–æ–∏–∑–Ω–æ—Å–∏—Ç—å —Ñ—Ä–∞–∑—É –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å –ø—Ä–∞–≤–∏–ª–∞–º–∏ –∏—Å–ø–∞–Ω—Å–∫–æ–≥–æ –ø—Ä–æ–∏–∑–Ω–æ—à–µ–Ω–∏—è:
- –ì–ª–∞—Å–Ω—ã–µ: —á—ë—Ç–∫–∏–µ a, e, i, o, u (–±–µ–∑ —Ä–µ–¥—É–∫—Ü–∏–∏); √°, √©, √≠, √≥, √∫ ‚Äî —É–¥–∞—Ä–µ–Ω–∏–µ –Ω–∞ –Ω—É–∂–Ω–æ–º —Å–ª–æ–≥–µ.
- –°–æ–≥–ª–∞—Å–Ω—ã–µ: √± (–æ—Ç–¥–µ–ª—å–Ω—ã–π –∑–≤—É–∫, –Ω–µ ¬´–Ω¬ª); r/rr/l —Ä–∞–∑–ª–∏—á–∞—é—Ç—Å—è; j [x]; ll; v –∏ b –≤ –∏—Å–ø–∞–Ω—Å–∫–æ–º —Ä–∞–∑–ª–∏—á–∞—é—Ç—Å—è.
- –ò–Ω—Ç–æ–Ω–∞—Ü–∏—è: –≤–æ–ø—Ä–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è ‚Äî –ø–æ–≤—ã—à–µ–Ω–∏–µ —Ç–æ–Ω–∞; –ø–∞—É–∑—ã –≤–º–µ—Å—Ç–æ –∑–∞–ø—è—Ç—ã—Ö.

–û—Ü–µ–Ω–∏–≤–∞–π –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –ø—Ä–æ–∏–∑–Ω–æ—à–µ–Ω–∏—è –≤ —Ü–µ–ª–æ–º: –∫–∞–∂–¥–∞—è –≥–ª–∞—Å–Ω–∞—è –∏ —Å–æ–≥–ª–∞—Å–Ω–∞—è –¥–æ–ª–∂–Ω–∞ –∑–≤—É—á–∞—Ç—å –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º –∏—Å–ø–∞–Ω—Å–∫–æ–≥–æ. –†–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω–∞—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è –æ—Ç—Ä–∞–∂–∞–µ—Ç, —á—Ç–æ —É—Å–ª—ã—à–∞–Ω–æ ‚Äî —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –æ—à–∏–±–∫—É (–≥—Ä–∞–º–º–∞—Ç–∏—á–µ—Å–∫—É—é –∏–ª–∏ –ø—Ä–æ–∏–∑–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—É—é).

–¢–∏–ø–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏ –ø—Ä–æ–∏–∑–Ω–æ—à–µ–Ω–∏—è (–≤–∏–¥–Ω—ã –≤ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏):
- v/b, r/rr/l, ll/y, j/g; √±‚Üín; –Ω–µ–≤–µ—Ä–Ω–æ–µ —É–¥–∞—Ä–µ–Ω–∏–µ (–ø—É—Ç–∞–Ω–∏—Ü–∞ –≥–ª–∞—Å–Ω—ã—Ö –ø–æ–¥ —É–¥–∞—Ä–µ–Ω–∏–µ–º).

–ü—Ä–∏ –Ω–µ–≤–µ—Ä–Ω–æ–º –æ—Ç–≤–µ—Ç–µ –≤ feedback_ru –¥–∞–π –∫—Ä–∞—Ç–∫–æ–µ –ø–æ—è—Å–Ω–µ–Ω–∏–µ –Ω–∞ —Ä—É—Å—Å–∫–æ–º:
- –ì—Ä–∞–º–º–∞—Ç–∏–∫–∞: —Ç–∏–ø ([–°–ø—Ä—è–∂–µ–Ω–∏–µ], [–ê—Ä—Ç–∏–∫–ª—å/–ø—Ä–µ–¥–ª–æ–≥]) –∏ –ø—Ä–∞–≤–∏–ª–æ.
- –ü—Ä–æ–∏–∑–Ω–æ—à–µ–Ω–∏–µ: —É–∫–∞–∂–∏, –∫–∞–∫–æ–π –∑–≤—É–∫/—Å–ª–æ–≥ –ø—Ä–æ–∏–∑–Ω–µ—Å—ë–Ω –Ω–µ–≤–µ—Ä–Ω–æ –∏ –∫–∞–∫ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º –∏—Å–ø–∞–Ω—Å–∫–æ–≥–æ.
1‚Äì2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è."""


async def check_voice_answer(expected: str, recognized_text: str) -> tuple[bool, str, str]:
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–π –≥–æ–ª–æ—Å–æ–≤–æ–π –æ—Ç–≤–µ—Ç –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –æ–∂–∏–¥–∞–µ–º–æ–π —Ñ—Ä–∞–∑–µ.
    –û—Ü–µ–Ω–∏–≤–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –ø—Ä–æ–∏–∑–Ω–æ—à–µ–Ω–∏–µ –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º –∏—Å–ø–∞–Ω—Å–∫–æ–≥–æ: –≥–ª–∞—Å–Ω—ã–µ, —Å–æ–≥–ª–∞—Å–Ω—ã–µ, —É–¥–∞—Ä–µ–Ω–∏—è, –∏–Ω—Ç–æ–Ω–∞—Ü–∏—è.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç (correct, feedback_ru, corrected).
    """
    client = _get_llm_client()
    if not client:
        # –°—Ç—Ä–æ–≥–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ: –≤—Å–µ –≥–ª–∞—Å–Ω—ã–µ –∏ —Å–æ–≥–ª–∞—Å–Ω—ã–µ –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º –∏—Å–ø–∞–Ω—Å–∫–æ–≥–æ
        user_clean = (recognized_text or "").strip().lower()
        exp_clean = (expected or "").strip().lower()
        if user_clean == exp_clean:
            return True, "–û—Ç–ª–∏—á–Ω–æ!", ""
        return False, "–ü—Ä–æ–≤–µ—Ä—å –ø—Ä–æ–∏–∑–Ω–æ—à–µ–Ω–∏–µ –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º –∏—Å–ø–∞–Ω—Å–∫–æ–≥–æ: –≥–ª–∞—Å–Ω—ã–µ, —Å–æ–≥–ª–∞—Å–Ω—ã–µ, —É–¥–∞—Ä–µ–Ω–∏—è, –∏–Ω—Ç–æ–Ω–∞—Ü–∏—é.", expected

    prompt = (
        f"–£—á–µ–Ω–∏–∫ –¥–æ–ª–∂–µ–Ω –±—ã–ª –ø—Ä–æ–∏–∑–Ω–µ—Å—Ç–∏ —Ñ—Ä–∞–∑—É –Ω–∞ –∏—Å–ø–∞–Ω—Å–∫–æ–º –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º –ø—Ä–æ–∏–∑–Ω–æ—à–µ–Ω–∏—è (–≥–ª–∞—Å–Ω—ã–µ, —Å–æ–≥–ª–∞—Å–Ω—ã–µ, —É–¥–∞—Ä–µ–Ω–∏—è, –∏–Ω—Ç–æ–Ω–∞—Ü–∏—è).\n\n"
        f"–û–∂–∏–¥–∞–µ–º–∞—è —Ñ—Ä–∞–∑–∞: {expected}\n"
        f"–†–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç (Whisper): {recognized_text}\n\n"
        "1) –°—Ä–∞–≤–Ω–∏ –°–¢–†–û–ì–û: —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –ø—Ä–∞–≤–∏–ª–∞–º –∏—Å–ø–∞–Ω—Å–∫–æ–≥–æ –ø—Ä–æ–∏–∑–Ω–æ—à–µ–Ω–∏—è ‚Äî –∫–∞–∂–¥–∞—è –≥–ª–∞—Å–Ω–∞—è –∏ —Å–æ–≥–ª–∞—Å–Ω–∞—è.\n"
        "2) –ï—Å–ª–∏ –Ω–µ–≤–µ—Ä–Ω–æ ‚Äî –æ–ø—Ä–µ–¥–µ–ª–∏: –≥—Ä–∞–º–º–∞—Ç–∏–∫–∞ (—Å–ø—Ä—è–∂–µ–Ω–∏–µ, –∞—Ä—Ç–∏–∫–ª—å) –∏–ª–∏ –ø—Ä–æ–∏–∑–Ω–æ—à–µ–Ω–∏–µ (–∑–≤—É–∫, —É–¥–∞—Ä–µ–Ω–∏–µ, –∏–Ω—Ç–æ–Ω–∞—Ü–∏—è).\n"
        "3) feedback_ru ‚Äî –ø–æ—è—Å–Ω–µ–Ω–∏–µ –Ω–∞ —Ä—É—Å—Å–∫–æ–º: –∫–∞–∫–æ–π –∑–≤—É–∫/—Å–ª–æ–≥ –ø—Ä–æ–∏–∑–Ω–µ—Å—ë–Ω –Ω–µ–≤–µ—Ä–Ω–æ –∏ –∫–∞–∫ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å.\n\n"
        '–û—Ç–≤–µ—Ç—å –¢–û–õ–¨–ö–û –≤–∞–ª–∏–¥–Ω—ã–º JSON:\n'
        '{"correct": true/false, "feedback_ru": "–ø–æ—è—Å–Ω–µ–Ω–∏–µ –Ω–∞ —Ä—É—Å—Å–∫–æ–º", "corrected": "—ç—Ç–∞–ª–æ–Ω–Ω–∞—è —Ñ—Ä–∞–∑–∞"}'
    )
    try:
        resp = await client.chat.completions.create(
            model="gpt-4o-mini",
            messages=[
                {"role": "system", "content": _VOICE_CHECK_SYSTEM},
                {"role": "user", "content": prompt},
            ],
            temperature=0,
        )
        text = resp.choices[0].message.content
        data = _parse_llm_json(text)
        if data:
            correct = data.get("correct", False)
            feedback_ru = data.get("feedback_ru", "")
            corrected = data.get("corrected", expected)
            return correct, feedback_ru or ("–û—Ç–ª–∏—á–Ω–æ!" if correct else "–ü—Ä–æ–≤–µ—Ä—å –æ—Ç–≤–µ—Ç."), corrected
    except Exception as e:
        logger.warning("LLM check_voice_answer error: %s", e)
    user_clean = (recognized_text or "").strip().lower()
    exp_clean = (expected or "").strip().lower()
    if user_clean == exp_clean:
        return True, "–í–µ—Ä–Ω–æ!", ""
    return False, "–ü—Ä–æ–≤–µ—Ä—å –ø—Ä–æ–∏–∑–Ω–æ—à–µ–Ω–∏–µ –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º –∏—Å–ø–∞–Ω—Å–∫–æ–≥–æ: –≥–ª–∞—Å–Ω—ã–µ, —Å–æ–≥–ª–∞—Å–Ω—ã–µ, —É–¥–∞—Ä–µ–Ω–∏—è, –∏–Ω—Ç–æ–Ω–∞—Ü–∏—é.", expected


async def check_fill_text(user_answer: str, expected: str) -> tuple[bool, str]:
    """
    –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–≤–µ—Ç–∞ fill_text. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç (is_correct, feedback).
    –ü—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ LLM ‚Äî —É–º–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å —É—á—ë—Ç–æ–º –∞–∫—Ü–µ–Ω—Ç–æ–≤/√±.
    –ò–Ω–∞—á–µ ‚Äî fallback: —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ normalize_spanish(user) —Å normalize_spanish(expected).
    """
    original_text = user_answer
    normalized_text = normalize_spanish(original_text)
    expected_norm = normalize_spanish(expected)

    # Fallback –±–µ–∑ API key
    client = _get_llm_client()
    if not client:
        if normalized_text == expected_norm:
            return True, "‚úÖ –í–µ—Ä–Ω–æ!"
        return False, f"‚ùå –ù–µ–≤–µ—Ä–Ω–æ.\nüëâ –ü—Ä–∞–≤–∏–ª—å–Ω–æ –±—É–¥–µ—Ç: {expected}"

    # LLM-–ø—Ä–æ–≤–µ—Ä–∫–∞
    messages = [
        {"role": "system", "content": _SYSTEM_PROMPT},
        {
            "role": "user",
            "content": (
                f"–ó–∞–¥–∞–Ω–∏–µ: –≤—Å—Ç–∞–≤–∏—Ç—å —Å–ª–æ–≤–æ –≤ –ø—Ä–æ–ø—É—Å–∫.\n"
                f"–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: {expected}\n\n"
                f"–û—Ç–≤–µ—Ç —É—á–µ–Ω–∏–∫–∞ (–æ—Ä–∏–≥–∏–Ω–∞–ª): {original_text}\n"
                f"–û—Ç–≤–µ—Ç —É—á–µ–Ω–∏–∫–∞ (–Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω): {normalized_text}"
            ),
        },
    ]
    for use_json_mode in (True, False):
        try:
            kwargs = {"model": "gpt-4o-mini", "messages": messages, "temperature": 0}
            if use_json_mode:
                kwargs["response_format"] = {"type": "json_object"}
            resp = await client.chat.completions.create(**kwargs)
            text = resp.choices[0].message.content
            data = _parse_llm_json(text)
            if data:
                correct = data.get("correct", False)
                # –ü–æ—Å—Ç–ø—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å–ª–∏ LLM –ø–æ–º–µ—Ç–∏–ª –Ω–µ–≤–µ—Ä–Ω–æ, –Ω–æ –æ—Ç–ª–∏—á–∏—è —Ç–æ–ª—å–∫–æ –≤ –∞–∫—Ü–µ–Ω—Ç–∞—Ö/√±/¬ø¬° ‚Äî —Å—á–∏—Ç–∞–µ–º –≤–µ—Ä–Ω–æ
                if not correct:
                    corrected = data.get("corrected_text", expected)
                    if normalize_spanish(original_text) == normalize_spanish(corrected):
                        correct = True
                return correct, "‚úÖ –í–µ—Ä–Ω–æ!" if correct else _format_feedback(data)
            logger.warning("LLM fill_text: –Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON: %s", text[:200] if text else "None")
            break
        except Exception as e:
            logger.warning("LLM fill_text error: %s", e)
            if not use_json_mode:
                break

    # Fallback –ø—Ä–∏ –æ—à–∏–±–∫–µ LLM
    if normalized_text == expected_norm:
        return True, "‚úÖ –í–µ—Ä–Ω–æ!"
    return False, f"‚ùå –ù–µ–≤–µ—Ä–Ω–æ.\nüëâ –ü—Ä–∞–≤–∏–ª—å–Ω–æ –±—É–¥–µ—Ç: {expected}"


async def evaluate_dialogue(
    user_text: str,
    prompt: str,
    expected: str | None = None,
    theory: str = "",
) -> str:
    """
    –û—Ü–µ–Ω–∫–∞ –¥–∏–∞–ª–æ–≥–∞ —á–µ—Ä–µ–∑ LLM. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç feedback –Ω–∞ —Ä—É—Å—Å–∫–æ–º.
    theory ‚Äî –∫–æ–Ω—Ç–µ–∫—Å—Ç —É—Ä–æ–∫–∞ (–≥—Ä–∞–º–º–∞—Ç–∏–∫–∞, –ª–µ–∫—Å–∏–∫–∞) –¥–ª—è –æ–ø–æ—Ä—ã –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ.
    """
    original_text = user_text
    normalized_text = normalize_spanish(original_text)

    # Fallback –±–µ–∑ API key
    client = _get_llm_client()
    if not client:
        if expected is not None:
            expected_norm = normalize_spanish(expected)
            if normalized_text == expected_norm:
                return "‚úÖ –í–µ—Ä–Ω–æ!"
            return f"‚ùå –ù–µ–≤–µ—Ä–Ω–æ.\nüëâ –ü—Ä–∞–≤–∏–ª—å–Ω–æ –±—É–¥–µ—Ç: {expected}"
        return (
            "‚ö†Ô∏è –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ –ò–ò –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ (–Ω–µ—Ç API –∫–ª—é—á–∞). "
            "–î–æ–±–∞–≤—å PROXYAPI_API_KEY –∏–ª–∏ OPENAI_API_KEY –≤ .env"
        )

    user_content = f"–ó–∞–¥–∞–Ω–∏–µ: {prompt}\n\n"
    if theory:
        user_content += f"–ö–æ–Ω—Ç–µ–∫—Å—Ç —É—Ä–æ–∫–∞ (–æ–ø–∏—Ä–∞–π—Å—è –Ω–∞ —ç—Ç–∏ –ø—Ä–∞–≤–∏–ª–∞): {theory}\n\n"
    user_content += f"–û—Ç–≤–µ—Ç —É—á–µ–Ω–∏–∫–∞ (–æ—Ä–∏–≥–∏–Ω–∞–ª): {original_text}\n"
    user_content += f"–û—Ç–≤–µ—Ç —É—á–µ–Ω–∏–∫–∞ (–Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω): {normalized_text}"

    # LLM-–æ—Ü–µ–Ω–∫–∞
    messages = [
        {"role": "system", "content": _SYSTEM_PROMPT},
        {"role": "user", "content": user_content},
    ]
    for use_json_mode in (True, False):
        try:
            kwargs = {"model": "gpt-4o-mini", "messages": messages, "temperature": 0.2}
            if use_json_mode:
                kwargs["response_format"] = {"type": "json_object"}
            resp = await client.chat.completions.create(**kwargs)
            text = resp.choices[0].message.content
            data = _parse_llm_json(text)
            if data:
                # –ü–æ—Å—Ç–ø—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å–ª–∏ LLM –ø–æ–º–µ—Ç–∏–ª –∫–∞–∫ –Ω–µ–≤–µ—Ä–Ω–æ, –Ω–æ –æ—Ç–ª–∏—á–∏—è —Ç–æ–ª—å–∫–æ –≤ –∞–∫—Ü–µ–Ω—Ç–∞—Ö/√±/¬ø¬° ‚Äî —Å—á–∏—Ç–∞–µ–º –≤–µ—Ä–Ω–æ
                if not data.get("correct", False):
                    corrected = data.get("corrected_text", "")
                    if corrected and normalize_spanish(original_text) == normalize_spanish(corrected):
                        return "‚úÖ –í–µ—Ä–Ω–æ!"
                return _format_feedback(data)
            logger.warning("LLM dialogue: –Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON: %s", text[:200] if text else "None")
            break
        except Exception as e:
            logger.warning("LLM dialogue error: %s", e)
            if not use_json_mode:
                break

    # Fallback –ø—Ä–∏ –æ—à–∏–±–∫–µ LLM (Connection error, timeout –∏ —Ç.–ø.)
    if expected is not None:
        expected_norm = normalize_spanish(expected)
        if normalized_text == expected_norm:
            return "‚úÖ –í–µ—Ä–Ω–æ!"
        return f"‚ùå –ù–µ–≤–µ—Ä–Ω–æ.\nüëâ –ü—Ä–∞–≤–∏–ª—å–Ω–æ –±—É–¥–µ—Ç: {expected}"
    return (
        "‚ö†Ô∏è –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ (–æ—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å API). "
        "–¢–≤–æ–π –æ—Ç–≤–µ—Ç –ø—Ä–∏–Ω—è—Ç ‚Äî –ø—Ä–æ–¥–æ–ª–∂–∞–π! –ö–æ–≥–¥–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è, –ø–æ–ª—É—á–∏—à—å —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç—É—é –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å."
    )
